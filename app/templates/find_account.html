<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ê³„ì • ì°¾ê¸°</title>
    <link rel="stylesheet" href="/static/chatbot.css">
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            padding: 20px;
            background-color: #f4f7f6;
        }

        .container {
            width: 400px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-menu {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 2px solid #eee;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            color: #999;
            font-weight: bold;
        }

        .tab-btn.active {
            color: #007bff;
            border-bottom: 2px solid #007bff;
            margin-bottom: -2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .row {
            display: flex;
            gap: 5px;
        }

        .row input {
            flex: 3;
        }

        .row button {
            flex: 1;
            white-space: nowrap;
            font-size: 0.8em;
            margin: 0px;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }

        button:hover {
            opacity: 0.9;
        }

        .result-box {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
            border: 1px dashed #abc;
        }

        .found-id {
            font-weight: bold;
            color: #007bff;
            font-size: 1.2em;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="tab-menu">
            <div class="tab-btn active" onclick="openTab('findId')">ì•„ì´ë”” ì°¾ê¸°</div>
            <div class="tab-btn" onclick="openTab('findPw')">ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸°</div>
        </div>

        <!-- 1. ì•„ì´ë”” ì°¾ê¸° íƒ­ -->
        <div id="findId" class="tab-content active">
            <div id="idFormArea">
                <div class="form-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="id_name" placeholder="ê°€ì…í•˜ì‹  ì´ë¦„ ì…ë ¥">
                </div>
                <div class="form-group">
                    <label>ì „í™”ë²ˆí˜¸</label>
                    <input type="text" id="id_phone" placeholder="01012345678">
                </div>
                <button type="button" onclick="handleFindId()">ì•„ì´ë”” í™•ì¸</button>
                <button onclick="location.href='/login'">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</button>
            </div>

            <div id="idResultBox" class="result-box">
                <p>ê°€ì…í•˜ì‹  ì´ë©”ì¼ ì•„ì´ë””ì…ë‹ˆë‹¤.</p>
                <div id="idResult" class="found-id"></div>
                <button onclick="location.href='/login'">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</button>
            </div>
        </div>

        <!-- 2. ë¹„ë°€ë²ˆí˜¸ ì°¾ê¸° íƒ­ -->
        <div id="findPw" class="tab-content">
            <div class="form-group">
                <label>ì´ë©”ì¼ (ID)</label>
                <div class="row">
                    <input type="email" id="pw_id" name="pw_id" required placeholder="example@mail.com"
                        value="ejrtn153@naver.com">
                    <button type="button" class="btn-verify" onclick="sendCode()">ì¸ì¦ ìš”ì²­</button>
                </div>
            </div>
            <div class="form-group">
                <label>ì¸ì¦ë²ˆí˜¸</label>
                <div class="row">
                    <input type="text" id="pw_code" name="pw_code" required placeholder="6ìë¦¬ ë²ˆí˜¸ ì…ë ¥">
                    <button type="button" class="btn-verify" onclick="checkCode()">ì¸ì¦ í™•ì¸</button>
                </div>
            </div>
            <div class="form-group">
                <label>ì´ë¦„</label>
                <input type="text" id="pw_name" placeholder="ì‹¤ëª… ì…ë ¥">
            </div>
            <div class="form-group">
                <label>ì „í™”ë²ˆí˜¸</label>
                <input type="text" id="pw_phone" placeholder="01012345678">
            </div>
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            <div class="form-group">
                <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</label>
                <input type="password" id="pw_new" placeholder="ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            </div>
            <button type="button" onclick="handleResetPw()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½í•˜ê¸°</button>
            <button onclick="location.href='/login'">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</button>
        </div>
    </div>

    <script>
        // íƒ­ ì „í™˜ ë¡œì§
        function openTab(tabName) {
            const contents = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-btn');

            contents.forEach(content => content.classList.remove('active'));
            buttons.forEach(btn => btn.classList.remove('active'));

            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // ì•„ì´ë”” ì°¾ê¸° ì²˜ë¦¬
        async function handleFindId() {
            const name = document.getElementById('id_name').value;
            const phone = document.getElementById('id_phone').value;

            if (!name || !phone) return alert("ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                // GET ìš”ì²­ìœ¼ë¡œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì „ë‹¬
                const response = await fetch(`/api/v1/users/find-id?name=${encodeURIComponent(name)}&phone_number=${encodeURIComponent(phone)}`);
                const result = await response.json();

                if (result.email) {
                    document.getElementById('idFormArea').style.display = 'none';
                    document.getElementById('idResultBox').style.display = 'block';
                    document.getElementById('idResult').innerText = result.email;
                } else {
                    alert("ì¼ì¹˜í•˜ëŠ” íšŒì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (e) {
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
            }
        }

        // 1. ì¸ì¦ë²ˆí˜¸ ë°œì†¡ í•¨ìˆ˜
        async function sendCode() {
            const userId = document.getElementById('pw_id').value;
            if (!userId) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                const response = await fetch(
                    `/api/v1/users/id-check?id=${encodeURIComponent(userId)}`, {
                    method: 'GET'
                });

                // ë‹¤ë¥¸ HTTP ì—ëŸ¬ë§Œ ì½˜ì†” ì¶œë ¥
                if (!response.ok) {
                    console.error("API Error:", response.status);
                    alert("ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    return;
                }else{
                    const result = await response.json();
                    if (!result.detail.includes("ì´ë¯¸")) {
                        alert(result.detail);
                        return;
                    }
                }

                // ì •ìƒì¼ ë•Œ ì¸ì¦ì½”ë“œ ë°œì†¡
                const response1 = await fetch('/api/v1/common/send-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: userId })
                });

                if (!response1.ok) {
                    console.error("Send Code Error:", response1.status);
                    alert("ì¸ì¦ì½”ë“œ ë°œì†¡ ì‹¤íŒ¨");
                    return;
                }

                const result1 = await response1.json();
                alert(result1.message);

            } catch (e) {
                alert("ë°œì†¡ ì‹¤íŒ¨");
            }
        }
        async function checkCode() {
            const userId = document.getElementById('pw_id').value;
            if (!userId) return alert("ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            const code = document.getElementById('pw_code').value;
            if (!code) return alert("ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            try {
                // ì •ìƒì¼ ë•Œ ì¸ì¦ì½”ë“œ í™•ì¸
                const response = await fetch('/api/v1/common/verify-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: userId, code: code })
                });

                // ì¸ì¦ í‹€ë¦¼ (ì •ìƒ ì²˜ë¦¬)
                if (response.status === 400) {
                    const result = await response.json();
                    alert(result.detail);
                    return;
                }

                if (!response.ok) {
                    console.error("API Error:", response.status);
                    alert("ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    return;
                }

                const result = await response.json();
                alert(result.message);
                document.querySelector("#pw_code").nextElementSibling.textContent = 'ì¸ì¦ ì™„ë£Œ'

            } catch (e) {
                alert("ë°œì†¡ ì‹¤íŒ¨");
            }
        }

        // ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì™„ë£Œ ì²˜ë¦¬
        async function handleResetPw() {
            const data = {
                id: document.getElementById('pw_id').value,
                name: document.getElementById('pw_name').value,
                phone_number: document.getElementById('pw_phone').value,
                new_password: document.getElementById('pw_new').value
            };

            if (Object.values(data).some(v => !v)) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            if(document.querySelector("#pw_code").nextElementSibling.textContent != 'ì¸ì¦ ì™„ë£Œ'){
                alert("ì´ë©”ì¼ ì¸ì¦ í•´ì£¼ì„¸ìš”.")
            }

            try {
                const response = await fetch('/api/v1/users/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.\nìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    location.href = "/login";
                } else {
                    const err = await response.json();
                    alert("ì˜¤ë¥˜: " + err.detail);
                }
            } catch (e) {
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
            }
        }
    </script>
</body>

<!-- ì±—ë´‡ UI -->
<button id="chatbot-button" class="chatbot-button">ğŸ¤–</button>
<div id="chatbot-container" class="chatbot-container">
  <div class="chatbot-header">
    <h3>ğŸ’¬ Cloud9 Care ì±—ë´‡</h3>
    <button id="chatbot-close" class="chatbot-close">Ã—</button>
  </div>
  <div id="chatbot-messages" class="chatbot-messages"></div>
  <div class="chatbot-input">
    <input id="chatbot-input" type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
    <button id="chatbot-send" class="chatbot-send">â¤</button>
  </div>
</div>
<script src="/static/chatbot.js"></script>

</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원가입 및 이메일 인증</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding: 20px; background-color: #f4f7f6; }
        .signup-container { width: 400px; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        .row { display: flex; gap: 5px; }
        .row input { flex: 3; }
        .row button { flex: 1; white-space: nowrap; font-size: 0.8em; }
        button { width: 100%; padding: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        button:hover { background-color: #218838; }
        .btn-verify { background-color: #007bff; }
        .btn-verify:hover { background-color: #0069d9; }
        .chronic_disease{
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .agreement-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fafafa;
            margin-bottom: 20px;
        }
        .agreement-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .agreement-item input { width: auto; margin-right: 10px; }
        .all-agree { border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; font-weight: bold; }
        .required { color: red; margin-left: 3px; }
        .item-open{ margin-left: auto; cursor: pointer; font-weight: 500;}
        .chronic_disease{
            width: 100%;
            resize: none;
            height: 75px;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="signup-container">
        <h2>회원가입</h2>
        <form id="signupForm">
            <div class="form-group">
                <label>이메일 (ID)</label>
                <div class="row">
                    <input type="email" id="email" name="email" required placeholder="example@mail.com" value="ejrtn153@naver.com">
                    <button type="button" class="btn-verify" onclick="sendCode()">인증 요청</button>
                </div>
            </div>
            <div class="form-group">
                <label>인증번호</label>
                <div class="row">
                    <input type="text" id="code" name="code" required placeholder="6자리 번호 입력">
                    <button type="button" class="btn-verify" onclick="checkCode()">인증 확인</button>
                </div>
            </div>
            <div class="form-group">
                <label>이름</label>
                <input type="text" name="name" id="name" maxlength="20" value="asdasd" required>
            </div>
            <div class="form-group">
                <label>닉네임</label>
                <input type="text" name="nickname" id="nickname" maxlength="20" value="asdasd" required>
            </div>
            <div class="form-group">
                <label>비밀번호</label>
                <input type="password" name="password" id="password" value="!Qq123456789" required>
            </div>
            <div class="form-group">
                <label>비밀번호 확인</label>
                <input type="password" name="password_check" id="password_check" value="!Qq123456789" required>
            </div>
            <div class="form-group">
                <label>전화번호</label>
                <input type="text" name="phone_number" id="phone_number" maxlength="11" value="01012341234" placeholder="01012345678" required>
            </div>
            <div class="form-group">
                <label>주민번호</label>
                <input type="text" name="id_card" id="id_card" maxlength="14" placeholder="900101-1234567" value="123456-1234567" required>
            </div>
            <label>만성 질환 (보유 시 작성)</label>
            <textarea id="chronic_disease" class="chronic_disease" name="chronic_disease" placeholder="예: 고혈압, 당뇨 등 (없으면 공란)">고혈압, 당뇨 등 (없으면 공란)</textarea>
            <div class="agreement-section">
                <div class="agreement-item all-agree">
                    <input type="checkbox" id="checkAll"> 전체 동의하기
                </div>
                <div class="agreement-item">
                    <input type="checkbox" class="agree-item" id="is_terms_agreed" name="is_terms_agreed" checked required>
                    <span>이용약관 동의<span class="required">(필수)</span></span>
                    <span class="item-open">보기</span>
                </div>
                <div class="agreement-item">
                    <input type="checkbox" class="agree-item" id="is_privacy_agreed" name="is_privacy_agreed" checked required>
                    <span>개인정보 처리방침 동의<span class="required">(필수)</span></span>
                    <span class="item-open">보기</span>
                </div>
                <div class="agreement-item">
                    <input type="checkbox" class="agree-item" id="is_marketing_agreed" name="is_marketing_agreed">
                    <span>마케팅 정보 수신 동의(선택)</span>
                    <span class="item-open">보기</span>
                </div>
            </div>
            <button type="button" class="ok">회원가입 완료</button>
        </form>
    </div>

    <script>
        // 1. 인증번호 발송 함수
        async function sendCode() {
            const email = document.getElementById('email').value;
            if(!email) return alert("이메일을 입력해주세요.");

            try {
                const response = await fetch(
                    `/api/v1/users/eamil-check?email=${encodeURIComponent(email)}`, {
                    method: 'GET'
                });

                // 이메일 중복 (정상 처리)
                if (response.status === 409) {
                    const result = await response.json();
                    alert(result.detail);
                    return;
                }

                // 다른 HTTP 에러만 콘솔 출력
                if (!response.ok) {
                    console.error("API Error:", response.status);
                    alert("에러가 발생했습니다.");
                    return;
                }

                // 정상일 때 인증코드 발송
                const response1 = await fetch('/api/v1/auth/send-code', { 
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email })
                });

                if (!response1.ok) {
                    console.error("Send Code Error:", response1.status);
                    alert("인증코드 발송 실패");
                    return;
                }

                const result1 = await response1.json();
                alert(result1.message || result1.detail);
                
            } catch (e) {
                alert("발송 실패");
            }
        }
        async function checkCode(){
            const email = document.getElementById('email').value;
            if(!email) return alert("이메일을 입력해주세요.");

            const code = document.getElementById('code').value;
            if(!code) return alert("인증번호를 입력해주세요.");

            try {
                // 정상일 때 인증코드 확인
                const response = await fetch('/api/v1/auth/verify-code', { 
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email: email, code: code })
                });
                
                // 인증 틀림 (정상 처리)
                if (response.status === 400) {
                    const result = await response.json();
                    alert(result.detail);
                    return;
                }

                if (!response.ok) {
                    console.error("API Error:", response.status);
                    alert("에러가 발생했습니다.");
                    return;
                }

                const result = await response.json();
                alert(result.message || result.detail);
                document.querySelector("#code").nextElementSibling.textContent = '인증 완료'
                
            } catch (e) {
                alert("발송 실패");
            }
        }

        // 2. 회원가입 제출 함수
        document.querySelector('#signupForm .ok').addEventListener("click", async (e) => {
            e.preventDefault();

            if(document.getElementById('email').value == ''){
                alert("이메일을 입력해주세요.")
                return;
            }
            if(document.getElementById('name').value == ''){
                alert("이름을 입력해주세요.")
                return;
            }
            if(document.getElementById('password').value == ''){
                alert("비밀번호를 입력해주세요.")
                return;
            }
            if(document.getElementById('password_check').value == ''){
                alert("비밀번호 확인을 입력해주세요.")
                return;
            }
            if(document.getElementById('password').value != document.getElementById('password_check').value){
                alert("비밀번호가 다릅니다..")
                return;
            }
            if(document.getElementById('phone_number').value == ''){
                alert("전화번호를 입력해주세요.")
                return;
            }
            if(document.getElementById('id_card').value == ''){
                alert("주민번호를 입력해주세요.")
                return;
            }

            if (!document.getElementById('is_terms_agreed').checked || 
                !document.getElementById('is_privacy_agreed').checked) {
                alert("필수 약관에 동의해주세요.");
                return;
            }

            const data = {
                email: document.getElementById('email').value,
                password: document.getElementById('password').value,
                name: document.getElementById('name').value,
                nickname: document.getElementById('nickname').value,
                phone_number: document.getElementById('phone_number').value,
                id_card: document.getElementById('id_card').value,
                is_terms_agreed: document.getElementById('is_terms_agreed').checked,
                is_privacy_agreed: document.getElementById('is_privacy_agreed').checked,
                is_marketing_agreed: document.getElementById('is_marketing_agreed').checked,
                chronic_disease: document.getElementById('chronic_disease').value,
            }

            console.log(data)
            try {
                const response = await fetch('/api/v1/auth/signup', { 
                    method: 'POST', 
                    headers: {
                        'Content-Type': 'application/json' // JSON을 보낸다고 서버에 알림
                    },
                    body: JSON.stringify(data)
                });

                // 인증 틀림 (정상 처리)
                if (response.status === 409) {
                    const result = await response.json();
                    alert(result.detail);
                    return;
                }

                if (!response.ok) {
                    console.error("API Error:", response.status);
                    alert("에러가 발생했습니다.");
                    return;
                }
                
                const result = await response.json();
                alert(result.message || result.detail);
                location.href = "/login"
            } catch (e) {
                alert("가입 실패");
            }
        });

    </script>
</body>
</html>
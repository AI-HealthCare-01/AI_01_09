<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <style>
        /* 기존 스타일 상속 */
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            padding: 20px;
            background-color: #f4f7f6;
        }

        .container {
            width: 400px;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        input:not([readonly]) {
            background-color: white;
        }

        button {
            width: 100%;
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
        }

        .btn-delete {
            background-color: #dc3545;
        }

        .btn-delete:hover {
            background-color: #c82333;
        }

        hr {
            margin: 25px 0;
            border: 0;
            border-top: 1px solid #eee;
        }

        .chronic_disease {
            width: 100%;
            resize: none;
            height: 75px;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
        }

        /* 약관 동의 관련 스타일 (join.html 참고) */
        .agreement-section {
            margin-top: 15px;
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #fafafa;
        }

        .agreement-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85em;
        }

        .agreement-item input {
            width: auto;
            margin-right: 10px;
        }

        .required {
            color: red;
            margin-left: 3px;
        }

        .item-open {
            margin-left: auto;
            cursor: pointer;
            font-weight: 500;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>마이페이지</h2>
        <form id="profileForm">
            <div class="form-group">
                <label>이메일 (ID)</label>
                <input type="email" id="email" readonly>
            </div>
            <div class="form-group">
                <label>이름</label>
                <input type="text" id="name" readonly>
            </div>
            <div class="form-group">
                <label>닉네임</label>
                <input type="text" id="nickname" name="nickname" required>
            </div>
            <div class="form-group">
                <label>전화번호</label>
                <input type="text" id="phone_number" name="phone_number" required>
            </div>
            <div class="form-group">
                <label>주민번호</label>
                <input type="text" id="id_card" name="id_card" required>
            </div>
            <div class="form-group">
                <label>만성질환 (보유 시 작성)</label>
                <textarea id="chronic_disease" class="chronic_disease" name="chronic_disease"
                    placeholder="예: 고혈압, 당뇨 등 (없으면 공란)"></textarea>
            </div>

            <div class="agreement-section">
                <div class="agreement-item">
                    <input type="checkbox" id="is_terms_agreed" disabled checked>
                    <span>이용약관 동의<span class="required">(필수)</span></span>
                    <span class="item-open">보기</span>
                </div>
                <div class="agreement-item">
                    <input type="checkbox" id="is_privacy_agreed" disabled checked>
                    <span>개인정보 처리방침 동의<span class="required">(필수)</span></span>
                    <span class="item-open">보기</span>
                </div>
                <div class="agreement-item">
                    <input type="checkbox" id="is_marketing_agreed" name="is_marketing_agreed">
                    <span>마케팅 정보 수신 동의(선택)</span>
                    <span class="item-open">보기</span>
                </div>
            </div>

            <button type="submit">정보 수정하기</button>
        </form>
        <button type="button" onclick="logout()" style="background-color: #6c757d; margin-top: 10px;">로그아웃</button>
        <hr>
        <h3>보안 설정</h3>
        <div class="form-group">
            <label>현재 비밀번호</label>
            <input type="password" id="old_password" placeholder="현재 비밀번호">
        </div>
        <div class="form-group">
            <label>새 비밀번호</label>
            <input type="password" id="new_password" placeholder="새 비밀번호">
        </div>
        <button type="button" onclick="changePassword()" style="background-color: #28a745;">비밀번호 변경</button>

        <hr>
        <div class="form-group">
            <label>비밀번호 확인 (탈퇴 시)</label>
            <input type="password" id="delete_password" placeholder="비밀번호를 입력하세요">
        </div>
        <button type="button" class="btn-delete" onclick="withdraw()">회원 탈퇴</button>
    </div>

    <script>
        // 공통 API 요청 함수 (토큰 만료 시 자동 갱신 로직 포함)
        async function fetchWithAuth(url, options = {}) {
            let accessToken = localStorage.getItem("access_token");
            const email = localStorage.getItem("user_email");

            if (!options.headers) options.headers = {};
            if (accessToken) {
                options.headers["Authorization"] = `Bearer ${accessToken}`;
            }

            let response = await fetch(url, options);

            // 토큰이 만료되었을 때 (401) 자동 갱신 시도
            if (response.status === 401) {
                console.log("액세스 토큰 만료, 갱신 시도 중...");
                const refreshResponse = await fetch('/api/v1/users/token/refresh', { method: 'GET' });

                if (refreshResponse.ok) {
                    const result = await refreshResponse.json();
                    accessToken = result.access_token;
                    localStorage.setItem("access_token", accessToken);

                    // 새 토큰으로 원래 요청 재시도
                    options.headers["Authorization"] = `Bearer ${accessToken}`;
                    response = await fetch(url, options);
                } else {
                    // 리프레시 토큰도 만료된 경우
                    alert("세션이 만료되었습니다. 다시 로그인해주세요.");
                    localStorage.removeItem("access_token");
                    localStorage.removeItem("user_email");
                    location.href = "/login";
                    return null;
                }
            }
            return response;
        }

        // 페이지 로드 시 정보 불러오기
        window.onload = async () => {
            const email = localStorage.getItem("user_email");
            if (!email) {
                location.href = "/login";
                return;
            }

            try {
                const response = await fetchWithAuth(`/api/v1/users/me?email=${encodeURIComponent(email)}`, {
                    method: 'GET'
                });

                if (!response || !response.ok) throw new Error("Fetch failed");

                const user = await response.json();
                document.getElementById('email').value = user.email;
                document.getElementById('name').value = user.name;
                document.getElementById('nickname').value = user.nickname;
                document.getElementById('phone_number').value = user.phone_number;
                document.getElementById('id_card').value = user.id_card;
                document.getElementById('chronic_disease').value = user.chronic_disease;

                // 약관 동의 상태 반영
                document.getElementById('is_terms_agreed').checked = user.is_terms_agreed;
                document.getElementById('is_privacy_agreed').checked = user.is_privacy_agreed;
                document.getElementById('is_marketing_agreed').checked = user.is_marketing_agreed;
            } catch (e) {
                console.error(e);
            }
        };

        // 정보 수정
        document.getElementById('profileForm').onsubmit = async (e) => {
            e.preventDefault();
            const data = {
                nickname: document.getElementById('nickname').value,
                phone_number: document.getElementById('phone_number').value,
                id_card: document.getElementById('id_card').value,
                chronic_disease: document.getElementById('chronic_disease').value,
                is_marketing_agreed: document.getElementById('is_marketing_agreed').checked,
            };

            const response = await fetchWithAuth('/api/v1/users/me', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response && response.ok) alert("수정 완료!");
            else if (response) alert("수정 실패");
        };

        // 로그아웃
        async function logout() {
            try {
                await fetchWithAuth('/api/v1/users/logout', { method: 'POST' });
            } catch (e) { }

            localStorage.removeItem("access_token");
            localStorage.removeItem("user_email");
            alert("로그아웃 되었습니다.");
            location.href = "/login";
        }

        // 비밀번호 변경
        async function changePassword() {
            const oldPassword = document.getElementById('old_password').value;
            const newPassword = document.getElementById('new_password').value;

            if (!oldPassword || !newPassword) return alert("비밀번호를 모두 입력하세요.");

            const response = await fetchWithAuth('/api/v1/users/me/password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    old_password: oldPassword,
                    new_password: newPassword
                })
            });

            if (response && response.ok) {
                alert("비밀번호가 변경되었습니다.");
                document.getElementById('old_password').value = "";
                document.getElementById('new_password').value = "";
            } else if (response) {
                const err = await response.json();
                alert("변경 실패: " + (err.detail || "정보를 확인해주세요."));
            }
        }

        // 회원 탈퇴
        async function withdraw() {
            const password = document.getElementById('delete_password').value;
            if (!password) return alert("비밀번호를 입력하세요.");

            if (confirm("정말로 탈퇴하시겠습니까? 데이터는 복구되지 않습니다.")) {
                const response = await fetchWithAuth('/api/v1/users/me', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });

                if (response && response.ok) {
                    localStorage.removeItem("access_token");
                    localStorage.removeItem("user_email");
                    alert("탈퇴되었습니다.");
                    location.href = "/";
                } else if (response) {
                    alert("비밀번호가 틀렸습니다.");
                }
            }
        }
    </script>
</body>

</html>